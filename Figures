
##libraries 
library(tidyr)
library(dplyr)
library(readr)
library(Biostrings)
library(biomaRt)
library(ggplot2)
library(edgeR)
library(ggrepel)
library(gt)
library(fgsea)
library(msigdbr)
library(clusterProfiler)
library(org.Hs.eg.db)
library(rtracklayer)
library(fmsb)
library(patchwork)
library(RColorBrewer)
library(cowplot)
library(grid)
library(png)
library(gridExtra)

########## FIGURE 1 ########## 

der <- df_1[,4:78] # from ref matrix
der <- as.matrix(der)

der2 <- der[rowMeans(der) > 50,]

anno <- read.table(file.choose(), header=T, sep = "\t")
anno <- anno[order(anno$ID),]

Mat <- der2
newnames<- sapply(strsplit(colnames(Mat),".EA"), `[`, 1)
colnames(Mat) <- newnames

#col_dend = as.dendrogram(hclust(dist(Mat)))
#col_dend = color_branches(col_dend, k = 2)

group_colors = c("Blymphocyte"="goldenrod1","Blymphocyte.Stim"="goldenrod","Tlymphocyte.Stim"="honeydew4","Tlymphocyte"="honeydew3","Myeloid"="red4","Platelets"="firebrick2","Breast"="violetred","Prostate"="dodgerblue4","Pancreas"="chartreuse4","Lung"="skyblue","Kidney"="coral","Colon"="sienna4")
ha = HeatmapAnnotation(Tissue = anno$Tissue, Type = anno$Type, col = list(Tissue = group_colors)) # phenotype info

Heatmap(log2(Mat+1), cluster_columns = T, name = "Log2 Expression",top_annotation = ha, show_column_names=F)
#Save PNG
png(
  filename = "high_res_newHM.png",
  width = 2800,   # Width in pixels (e.g., 2400 pixels for an 8-inch wide image at 300 dpi)
  height = 1800,  # Height in pixels (e.g., 1800 pixels for a 6-inch high image at 300 dpi)
  res = 300       # Resolution in pixels per inch (dpi)
)

Heatmap(log2(Mat+1), cluster_columns = T, name = "Log2 Expression",top_annotation = ha, show_column_names=F)
# Close the graphics device to save the file
dev.off()

########## Figure 2 ##########

pheno$Batch <- relevel(factor(pheno$Batch,levels=unique(pheno$Batch)),ref="1")
pheno$Type <- relevel(factor(pheno$Type,levels=unique(pheno$Type)),ref="SEV")
pheno$Tissue <- relevel(factor(pheno$Tissue,levels=unique(pheno$Tissue)), ref= "Colon")
pheno$Status <- relevel(factor(pheno$Status,levels=unique(pheno$Status)),ref="Normal")
pheno$Sex <- relevel(factor(pheno$Sex,levels=unique(pheno$Sex)), "F")

Types<- pheno$Type
Tissues<- pheno$Tissue
Statuses<- pheno$Status
Sexs<- pheno$Sex
design_matrix <- model.matrix(~ Types + Tissues +Statuses +Sexs)

dge2 <- dge
dge2 <- estimateGLMCommonDisp(dge2, design_matrix)
dge2 <- estimateGLMTrendedDisp(dge2, design_matrix)
dge2 <- estimateGLMTagwiseDisp(dge2, design_matrix)

par(mfrow=c(1,1))
plotBCV(dge2, main = "BCV plot ")

dge_filtered <- dge2[dge2$AveLogCPM > 2, , keep.lib.sizes = FALSE]

par(mfrow=c(1,1))
plotBCV(dge_filtered, main = "BCV plot ")

#redo graph
dge_filtered <- estimateGLMCommonDisp(dge_filtered, design_matrix)
dge_filtered <- estimateGLMTrendedDisp(dge_filtered, design_matrix)
dge_filtered <- estimateGLMTagwiseDisp(dge_filtered, design_matrix)

par(mfrow=c(1,1))
plotBCV(dge_filtered, main = "BCV plot ")

fit.f<-glmFit(dge_filtered ,design_matrix)

Cell <- glmLRT(fit.f, coef = 2)
LEV <- glmLRT(fit.f, coef = 3)
Cancer<- glmLRT(fit.f, coef = 15)

res_Cell<-topTags(Cell,nrow(dge_filtered$counts))
res_LEV<-topTags(LEV,nrow(dge_filtered$counts))
res_Cancer<-topTags(Cancer,nrow(dge_filtered$counts))
all_res_M <- list(res_Cell,res_LEV, res_Cancer)

pval_Cell<- data.frame(raw.pvalue = Cell$table$PValue,
                   FDR=p.adjust(Cell$table$PValue, "BH"))
pval_LEV<- data.frame(raw.pvalue = LEV$table$PValue,
                   FDR=p.adjust(LEV$table$PValue, "BH"))
pval_Cancer<- data.frame(raw.pvalue = Cancer$table$PValue,
                      FDR=p.adjust(Cancer$table$PValue, "BH"))

hist(pval_Cell$raw.pvalue,150)
hist(pval_LEV$raw.pvalue,150)
hist(pval_Cancer$raw.pvalue,150)

for (i in seq(1:length(all_res_M)))
{
  res_M <- all_res_M[[i]]
  table_data <- res_M$table  
  filename <- paste0("results_",res_M$comparison , ".csv")
  write.csv(table_data, file = filename, row.names = TRUE)
}

FDR_THRESHOLD=0.05
UP_THRESHOLD=0.6
DOWN_THRESHOLD=-0.6
for (i in seq(1:length(all_res_M)))
{
  res_M <- all_res_M[[i]]
  plot_title <- paste0("volcano plot ",res_M$comparison) 
  #add column that says if gene is significant or not
  mutateddf <- mutate(res_M$table, significant=ifelse(res_M$table$FDR<FDR_THRESHOLD, 1, 0))
  
  #add column that says if up or downregulated SSI the gene is considered significant
  mutateddf <- mutate(mutateddf, diffexp=ifelse((mutateddf$logFC>UP_THRESHOLD & mutateddf$significant==1), "UP", (ifelse((mutateddf$logFC<DOWN_THRESHOLD & mutateddf$significant==1), "DOWN", "NO"))))
  
  #add gene names in a column
  input <- cbind(gene=rownames(mutateddf), mutateddf)
  
  volc = ggplot(input, aes(logFC, -log10(FDR)))+
    geom_point(aes(col=diffexp))+ #add points colored by significance
    scale_color_manual(labels=c("Downregulated", "Not significant", "Upregulated"), values=c("red", "black","blue"))+ 
    ggtitle(plot_title)+
    theme(legend.position='none')+
    geom_text_repel(data=head(input, 10), aes(label=gene))+ #adding text for the top 10 (input is already sorted by FDR)
    geom_hline(yintercept=-log10(FDR_THRESHOLD), linetype="dashed", color = "darkgrey")+
    geom_vline(xintercept = UP_THRESHOLD, linetype="dashed", color = "darkgrey")+
    geom_vline(xintercept = DOWN_THRESHOLD, linetype="dashed", color = "grey")
  
  print(volc+theme_classic())
  
}

##add gene names 
res_table1 <- res_Cell$table
res_table1$region <- rownames(res_table1)  
res_Cell_genes <- merge(res_table1, data_gene_types_and_names, by = "region")
res_table2 <- res_LEV$table
res_table2$region <- rownames(res_table2)  
res_LEV_genes <- merge(res_table2, data_gene_types_and_names, by = "region")
res_table3 <- res_Cancer$table
res_table3$region <- rownames(res_table3)  
res_Cancer_genes <- merge(res_table3, data_gene_types_and_names, by = "region")
all_res_M_genes <- list(res_Cell_genes,res_LEV_genes, res_Cancer_genes)
comparisons <- list("Cell","LEV", "Cancer")

for (i in seq(1:length(all_res_M_genes)))
{
  res_M <- all_res_M_genes[[i]]
  plot_title <- paste0("Volcano Plot ", comparisons[i]) 
  #add column that says if gene is significant or not
  mutateddf <- mutate(res_M, significant=ifelse(res_M$FDR<FDR_THRESHOLD, 1, 0))
  
  #add column that says if up or downregulated SSI the gene is considered significant
  mutateddf <- mutate(mutateddf, diffexp=ifelse((mutateddf$logFC>UP_THRESHOLD & mutateddf$significant==1), "UP", (ifelse((mutateddf$logFC<DOWN_THRESHOLD & mutateddf$significant==1), "DOWN", "NO"))))
  
  res_M <- res_M %>%mutate(assigned_gene = ifelse(is.na(gene_name), sub(":.*", "", region),sub(",.*", "", gene_name) ) )
  #add gene names in a column
  input <- cbind(gene= res_M$assigned_gene, mutateddf) %>% dplyr::select (-c(2,8,9,10))
  top_genes <- input %>%
    filter(diffexp != "NO") %>%
    arrange(FDR) %>%
    slice_head(n = 10)
  
  volc = ggplot(input, aes(logFC, -log10(FDR)))+
    geom_point(aes(col=diffexp))+ #add points colored by significance
    scale_color_manual(labels=c("Downregulated", "Not significant", "Upregulated"), values=c("red", "black","blue"))+ 
    ggtitle(plot_title)+
    theme(legend.position='none')+
    geom_text_repel(data=top_genes, aes(label=gene))+ #adding text for the top 10 (input is already sorted by FDR)
    geom_hline(yintercept=-log10(FDR_THRESHOLD), linetype="dashed", color = "darkgrey")+
    geom_vline(xintercept = UP_THRESHOLD, linetype="dashed", color = "darkgrey")+
    geom_vline(xintercept = DOWN_THRESHOLD, linetype="dashed", color = "grey")
  
  print(volc+theme_classic())
  
}

##interactive plot
for (i in seq_along(all_res_M_genes)) {
  res_M <- all_res_M_genes[[i]]
  plot_title <- paste0("Volcano Plot ", comparisons[i])
  mutateddf <- mutate(res_M, significant = ifelse(FDR < FDR_THRESHOLD, 1, 0))
  mutateddf <- mutate(mutateddf,
                      diffexp = ifelse(logFC > UP_THRESHOLD & significant == 1, "UP",
                                       ifelse(logFC < DOWN_THRESHOLD & significant == 1, "DOWN", "NO")))
  res_M <- res_M %>%
    mutate(assigned_gene = ifelse(is.na(gene_name),
                                  sub(":.*", "", region),
                                  sub(",.*", "", gene_name)))
  input <- cbind(gene = res_M$assigned_gene, mutateddf) %>%
    dplyr::select(-c(2, 8, 9, 10))  
  
  top_genes <- input %>%
    filter(diffexp != "NO") %>%
    arrange(FDR) %>%
    slice_head(n = 10)
  
  # create ggplot
  volc <- ggplot(input, aes(logFC, -log10(FDR), text = paste("Gene:", gene))) +  # <--- text for tooltips
    geom_point(aes(color = diffexp)) +
    scale_color_manual(labels = c("Downregulated", "Not significant", "Upregulated"),
                       values = c("red", "black", "blue")) +
    ggtitle(plot_title) +
    theme_classic() +
    theme(legend.position = 'right') +
    geom_text_repel(data = top_genes, aes(label = gene), max.overlaps = 20) +
    geom_hline(yintercept = -log10(FDR_THRESHOLD), linetype = "dashed", color = "darkgrey") +
    geom_vline(xintercept = UP_THRESHOLD, linetype = "dashed", color = "darkgrey") +
    geom_vline(xintercept = DOWN_THRESHOLD, linetype = "dashed", color = "grey")
  
  # make interactive
  interactive_volc <- ggplotly(volc, tooltip = "text")
  print(interactive_volc)
}

der <- df_1[,4:78] # from ref matrix
der <- as.matrix(der)

der2 <- der[rowMeans(der) > 50,]

anno <- read.table(file.choose(), header=T, sep = "\t")
anno <- anno[order(anno$ID),]

Mat <- der2
newnames<- sapply(strsplit(colnames(Mat),".EA"), `[`, 1)
colnames(Mat) <- newnames

#col_dend = as.dendrogram(hclust(dist(Mat)))
#col_dend = color_branches(col_dend, k = 2)
ha = HeatmapAnnotation(Tissue = anno$Tissue, Type = anno$Type) # phenotype info

Heatmap(log2(Mat+1), cluster_columns = T, name = "Log2 Expression",top_annotation = ha, show_column_names=F)
#Save PNG

pseudo_counts <- log2(Mat+1)
pseudo_counts_cen <- pseudo_counts - rowMeans(pseudo_counts)
svd1<-svd(pseudo_counts_cen)
svd_percent<-(svd1$d^2/sum(svd1$d^2))
plot(svd_percent,main="% variance explained",col=2)

plot(svd1$v[,1],svd1$v[,2],ylab="2nd PC",xlab="1st PC")

PCA <- cbind(svd1$v[,1], svd1$v[,2], anno$Type)
colnames(PCA) <- c("PC1", "PC2", "Type")
PCA <- as.data.frame(PCA)
PCA$PC1 <- as.numeric(PCA$PC1)
PCA$PC2 <- as.numeric(PCA$PC2)

g <- ggplot(PCA) + geom_point(aes(x = PC1, y=PC2, colour=`Type`), size = 2.5)+ labs(title="", x="1st Principal Component", y = "2nd Principal Component") + theme_bw()
g
ggsave("PCA.png", dpi = 600, width=5, height = 4,g)

########## Figure 3 ##########

df<-read_csv("C:/Users/vrm211/Desktop/Docs/Deconv/Figures Finales/OneDrive_2_10-24-2025/results_TypesLEV.csv")
#df <- read_csv("C:/Users/Chloe/OneDrive - Université de Moncton/IARC/coding/Projects/EVs/DEA/results/All/Tableaux/results_StatusesCancer.csv")
#df <- read_csv("C:/Users/Chloe/OneDrive - Université de Moncton/IARC/coding/Projects/EVs/DEA/results/All/Tableaux/results_TypesCell.csv")
df$gene<- df$...1
df <- df %>% separate(gene, into = c("chr", "range"), sep = ":\\s*") %>%  separate(range, into = c("start", "end"), sep = "-")  
df$gene <- df$...1
df <- dplyr::select(df, -1)

gtf <- import("C:/Users/vrm211/Downloads/gencode.v49.annotation.gtf.gz")  
genes <- gtf[gtf$type == "gene"]
gr <- GRanges(seqnames = df$chr, ranges = IRanges(start = as.numeric(df$start), end = as.numeric(df$end)))
hits <- findOverlaps(gr, genes)
results <- data.frame(gene = df$gene[queryHits(hits)],gene_type = mcols(genes)$gene_type[subjectHits(hits)],gene_name = mcols(genes)$gene_name[subjectHits(hits)])
results <- dplyr::distinct(results, gene, gene_type, gene_name, .keep_all = TRUE)

# Suppose your dataframe is called df with columns:
# df$gene     = gene symbols
# df$logFC    = log fold change
# df$pval     = p-value

df1<- merge(df, results, .by=gene)
library(clusterProfiler)
library(org.Hs.eg.db)

# 1. Create ranking metric
df1$score <- sign(df1$logFC) * -log10(df1$FDR)

# 2. Sort by score
df1 <- df1[order(df1$score, decreasing = TRUE), ]

# 3. Map SYMBOL to Entrez ID
gene.df <- bitr(df1$gene_name,
                fromType = "SYMBOL",
                toType = "ENTREZID",
                OrgDb = org.Hs.eg.db)

# 4. Merge mapping back to keep scores
df.mapped <- merge(df1, gene.df, by.x = "gene_name", by.y = "SYMBOL")
library(dplyr)

# Deduplicate: keep max score per Entrez ID
df.unique <- df.mapped %>%
  group_by(ENTREZID) %>%
  summarise(score = mean(score)) %>%
  ungroup()

# Build ranks vector
ranks <- df.unique$score
names(ranks) <- df.unique$ENTREZID
ranks <- sort(ranks, decreasing = TRUE)


# 6. Run KEGG GSEA
gsea.kegg <- gseKEGG(geneList = ranks,
                     organism = "hsa",
                     minGSSize = 10,
                     maxGSSize = 500,
                     pvalueCutoff = 0.10)

ridgeplot(gsea.kegg)+ labs(x = "enrichment distribution") #(800*400)
write.table(gsea.kegg@result, file = "LEV_kegg.tsv", quote = F, sep = "\t")

########## Figure 4 ##########

# Ground truth data
ground_truth_data <- data.frame(
  Mix = c("Mix1", "Mix2", "Mix3", "Mix4", "Mix5", "Mix6"),
  Breast = c(0.15, 0, 0.15, 0, 0.15, 0),
  Blymphocyte = c(0.05, 0, 0.05, 0, 0.05, 0.1),
  `Blymphocyte.stim` = c(0.1, 0, 0.1, 0, 0.1, 0.2),
  Kidney = c(0.5, 0, 0.5, 0.1, 0.5, 0),
  Colon = c(0.2, 0, 0.2, 0.05, 0.2, 0),
  Myeloid = c(0, 0.1, 0, 0, 0, 0.2),
  Lung = c(0, 0.05, 0, 0.15, 0, 0),
  Pancreas = c(0, 0.15, 0, 0.5, 0, 0),
  Platelets = c(0, 0.2, 0, 0, 0, 0.2),
  Prostate = c(0, 0.5, 0, 0.2, 0, 0),
  TLymphocyte = c(0, 0, 0, 0, 0, 0.1),
  `Tlymphocyte.Stim` = c(0.1, 0, 0.1, 0, 0.1, 0.2)
)

# Convert to proportions
row_sums <- rowSums(ground_truth_data[, -1])
ground_truth_proportions <- ground_truth_data
for (i in 2:ncol(ground_truth_proportions)) {
  ground_truth_proportions[, i] <- ground_truth_proportions[, i] / row_sums
}

# Method data (CIBERSORT, MuSiC, etc.)
cibersort_data <- data.frame(
  Mix = c("Mix1", "Mix2", "Mix3", "Mix4", "Mix5", "Mix6"),
  Blymphocyte = c(0.03544808, 0, 0.03252584, 0, 0.03250260, 0.08171565),
  Blymphocyte.stim = c(0.08664369, 0.00126137, 0.08088334, 0, 0.08271591, 0.09938276),
  Breast = c(0.11235536, 0.01629801, 0.09664910, 0, 0.09964531, 0),
  Colon = c(0.25059464, 0, 0.23872318, 0.02845874, 0.23804884, 0.06797212),
  Kidney = c(0.43977047, 0.00179195, 0.45368759, 0.09968292, 0.45652048, 0.00471870),
  Lung = c(0, 0, 0, 0.09055198, 0, 0),
  Myeloid = c(0.00849479, 0.11615454, 0.01207317, 0.03619246, 0.01252438, 0.18837339),
  Pancreas = c(0, 0.09053287, 0, 0.35302824, 0, 0.07521662),
  Platelets = c(0.00341864, 0.26163745, 0.00324551, 0.00125320, 0.00341519, 0.22299663),
  Prostate = c(0.05182007, 0.44337890, 0.05666456, 0.33556718, 0.05160016, 0),
  TLymphocyte = c(0.01145425, 0.06894490, 0.02554770, 0.05526527, 0.02302712, 0.16715631),
  Tlymphocyte.Stim = c(0, 0, 0, 0, 0, 0.09246781)
)

music_data <- data.frame(
  Mix = c("Mix1", "Mix2", "Mix3", "Mix4", "Mix5", "Mix6"),
  Blymphocyte = c(0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000),
  Blymphocyte.stim = c(0.1521, 0.0292, 0.1518, 0.0000, 0.1518, 0.3735),
  Breast = c(0.1379, 0.0895, 0.1409, 0.1444, 0.1455, 0.0000),
  Colon = c(0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000),
  Kidney = c(0.4850, 0.0000, 0.4841, 0.1926, 0.4845, 0.0118),
  Lung = c(0.0386, 0.0000, 0.0405, 0.0272, 0.0388, 0.0000),
  Myeloid = c(0.0000, 0.0334, 0.0000, 0.0000, 0.0000, 0.0840),
  Pancreas = c(0.1832, 0.6284, 0.1785, 0.4941, 0.1753, 0.0000),
  Platelets = c(0.0031, 0.2194, 0.0042, 0.0000, 0.0041, 0.3105),
  Prostate = c(0.0000, 0.0000, 0.0000, 0.1417, 0.0000, 0.0000),
  TLymphocyte = c(0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000),
  Tlymphocyte.Stim = c(0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.2202)
)

dual_simplex_data <- data.frame(
  Mix = c("Mix1", "Mix2", "Mix3", "Mix4", "Mix5", "Mix6"),
  Blymphocyte = c(2.976693e-18, 7.238377e-18, 3.810873e-18, -7.684857e-17, 1.201748e-18, 3.167624e-01),
  Blymphocyte.stim = c(7.574810e-17, -1.390507e-17, 1.199754e-16, -6.873815e-17, 7.879790e-17, -4.377621e-17),
  Breast = c(2.211915e-01, -1.902651e-18, 2.015607e-01, 3.899711e-02, 2.230418e-01, 8.847443e-18),
  Colon = c(1.738153e-17, 5.949081e-17, -3.138531e-17, 2.658724e-17, -2.370326e-17, 3.372543e-17),
  Kidney = c(7.788085e-01, -9.151554e-20, 7.789732e-01, 5.110100e-01, 7.769582e-01, 2.137894e-02),
  Lung = c(2.292003e-16, -2.691641e-18, 1.467332e-16, -1.953111e-16, 1.623951e-16, -3.679393e-18),
  Myeloid = c(-3.110588e-17, -1.203341e-17, 3.859512e-18, -9.090631e-18, 3.661281e-18, 1.622476e-01),
  Pancreas = c(9.840948e-20, 2.812259e-01, 1.946611e-02, 4.457316e-01, -8.456681e-20, 9.897054e-18),
  Platelets = c(1.965248e-19, 4.597098e-01, -2.979761e-18, -2.174889e-18, -7.746821e-18, 4.996111e-01),
  Prostate = c(-4.045234e-16, 2.590643e-01, -3.853790e-16, 4.261314e-03, -3.972425e-16, -4.676349e-17),
  TLymphocyte = c(1.846640e-17, 8.554129e-17, -2.019911e-17, -6.120612e-17, -9.974101e-18, 3.153791e-18),
  Tlymphocyte.Stim = c(4.555504e-18, -1.226786e-16, -1.787359e-16, -7.578306e-18, -1.620348e-16, -3.279305e-17)
)

nmf_data <- data.frame(
  Mix = c("Mix1", "Mix2", "Mix3", "Mix4", "Mix5", "Mix6"),
  Kidney = c(0.457979119488629, 0.185977102488706, 0.531021251206337, 0.502372808205509, 0.533846250843462, 0),
  Prostate = c(0.148089221818423, 0.143953065170294, 0.128478892224605, 0.369368737367811, 0.128807232839981, 0),
  Blymphocyte = c(0.291652417773992, 0, 0.279720122165664, 0.0901060282196631, 0.281617015935284, 0.642201452023517),
  Lung = c(0.0850678482028392, 0, 0.0400326835047353, 0, 0.033927058695742, 0),
  Platelets = c(0.0172113927161165, 0.670069832341001, 0.0207470508986588, 0.0381524262070174, 0.0218024416855307, 0.357798547976483),
  Blymphocyte.stim = c(0, 0, 0, 0, 0, 0),
  Breast = c(0, 0, 0, 0, 0, 0),
  Colon = c(0, 0, 0, 0, 0, 0),
  Myeloid = c(0, 0, 0, 0, 0, 0),
  Pancreas = c(0, 0, 0, 0, 0, 0),
  TLymphocyte = c(0, 0, 0, 0, 0, 0),
  Tlymphocyte.Stim = c(0, 0, 0, 0, 0, 0)
)

nlls_data <- data.frame(
  Mix = c("Mix1", "Mix2", "Mix3", "Mix4", "Mix5", "Mix6"),
  Blymphocyte = c(0.00000000, 0.00000000, 0.00000000, 0.00000000, 0.00000000, 0.01346631),
  Blymphocyte.stim = c(0.14497517, 0.06518118, 0.14463538, 0.07297522, 0.14496675, 0.17008175),
  Breast = c(0.20239329, 0.07195102, 0.20496013, 0.06024032, 0.20700451, 0.04195438),
  Colon = c(0, 0, 0, 0, 0, 0),
  Kidney = c(0.20581673, 0.00000000, 0.20448794, 0.06222798, 0.20492304, 0.00000000),
  Lung = c(0.114395529, 0.075318773, 0.115758372, 0.173507490, 0.114689313, 0.002686254),
  Myeloid = c(0.00000000, 0.07400891, 0.00000000, 0.00000000, 0.00000000, 0.14655733),
  Pancreas = c(0.2176951, 0.2787699, 0.2137560, 0.4543043, 0.2124891, 0.2382445),
  Platelets = c(0.02487181, 0.21880772, 0.02554621, 0.01358061, 0.02555993, 0.21202936),
  Prostate = c(0.0000000, 0.1941958, 0.0000000, 0.1175246, 0.0000000, 0.0000000),
  TLymphocyte = c(0, 0, 0, 0, 0, 0),
  Tlymphocyte.Stim = c(0.08985239, 0.02176675, 0.09085595, 0.04563950, 0.09036731, 0.17498015)
)

nlls_quadprog_data <- data.frame(
  Mix = c("Mix1", "Mix2", "Mix3", "Mix4", "Mix5", "Mix6"),
  Blymphocyte = c(0.13890662, 0.01790041, 0.13438085, 0.00000000, 0.13809594, 0.15230924),
  Blymphocyte.stim = c(0.01885689, 0.11195282, 0.02396899, 0.09890843, 0.01059959, 0.11621152),
  Breast = c(0.15009062, 0.05285325, 0.12813621, 0.06800441, 0.13039702, 0.06593136),
  Colon = c(0.18793321, 0.03400344, 0.18371456, 0.06060474, 0.18506425, 0.03504738),
  Kidney = c(0.23002136, 0.00000000, 0.22326926, 0.08466211, 0.23301971, 0.00000000),
  Lung = c(0.06017492, 0.08174585, 0.07365307, 0.15710046, 0.06941715, 0.04274868),
  Myeloid = c(0.05374678, 0.10938500, 0.05719799, 0.02843053, 0.05552310, 0.13377374),
  Pancreas = c(0.00000000, 0.09745456, 0.02085993, 0.18935251, 0.01879435, 0.06185263),
  Platelets = c(0.03130424, 0.13532285, 0.02645816, 0.04282437, 0.02304654, 0.12940003),
  Prostate = c(0.000000000, 0.231680540, 0.000000000, 0.120704113, 0.000000000, 0.006297306),
  TLymphocyte = c(0.11643794, 0.03882258, 0.11013243, 0.03525185, 0.10816389, 0.13252163),
  Tlymphocyte.Stim = c(0.01252742, 0.08887870, 0.01822855, 0.11415648, 0.02787847, 0.12390649)
)

hspe_data <- data.frame(
  Mix = c("Mix1", "Mix2", "Mix3", "Mix4", "Mix5", "Mix6"),
  Blymphocyte = c(0.0615462915975005, 2.10986670974832e-14, 0.056581668354361, 1.63333935287624e-14, 0.0538422302761945, 0.109253055838156),
  Blymphocyte.stim = c(0.17205189564674, 8.9529327722133e-15, 0.149085653208496, 2.12357239506118e-14, 0.158076349966032, 0.565480232581023),
  Breast = c(0.159174908896492, 1.12054921216177e-12, 0.157809904032517, 2.37654512353938e-12, 0.168462474830569, 8.15028066494612e-14),
  Colon = c(0.184944097814528, 0.000860432365042374, 0.215606708016647, 0.0440677338966095, 0.216085511553033, 0.0017857447927055),
  Kidney = c(0.374188781259241, 0.000276500335019246, 0.369621003708629, 0.0638667986895588, 0.359589944467675, 0.000600596018706707),
  Lung = c(0.00113345682398526, 0.0555962521047241, 0.00253299657465361, 0.0691174535927729, 0.00392343153901516, 0.0318630911936676),
  Myeloid = c(0.000410236518530606, 0.0405496285468119, 0.000551736347792372, 0.000350613878038412, 0.000542608602068294, 0.0826691200391667),
  Pancreas = c(0.0419007094640993, 0.125321093618446, 0.0445982183455745, 0.480411225036451, 0.0280126639522533, 0.000201941790806037),
  Platelets = c(8.29940111804725e-06, 0.0500390217826638, 1.40926938417996e-05, 2.48108732758093e-06, 1.23863298025725e-05, 0.0534074739655798),
  Prostate = c(2.25871144600948e-11, 0.726862588963815, 0.0016033206481104, 0.341233007697635, 0.00695016108583158, 1.19323243989806e-12),
  TLymphocyte = c(0.0046413225549792, 2.01007047484897e-05, 0.00199469806852641, 0.0003042093938911, 0.00210970378859576, 0.0726900406644244),
  Tlymphocyte.Stim = c(1.98289893473012e-13, 0.000474381577578971, 8.49851697974119e-13, 0.000646476725300891, 0.00239253360892957, 0.08204870311449)
)

# Calculate metrics function
calculate_metrics <- function(predicted_data, ground_truth_data, method_name) {
  pred_matrix <- as.matrix(predicted_data[, -1])
  truth_matrix <- as.matrix(ground_truth_data[, -1])
  
  pred_matrix <- apply(pred_matrix, 2, as.numeric)
  truth_matrix <- apply(truth_matrix, 2, as.numeric)
  
  rmse <- sqrt(mean((pred_matrix - truth_matrix)^2))
  mae <- mean(abs(pred_matrix - truth_matrix))
  correlation <- cor(as.vector(pred_matrix), as.vector(truth_matrix))
  
  ss_res <- sum((as.vector(pred_matrix) - as.vector(truth_matrix))^2)
  ss_tot <- sum((as.vector(truth_matrix) - mean(as.vector(truth_matrix)))^2)
  r_squared <- 1 - (ss_res / ss_tot)
  
  threshold <- 0.01
  pred_binary <- pred_matrix > threshold
  truth_binary <- truth_matrix > threshold
  
  tp <- sum(pred_binary & truth_binary)
  fp <- sum(pred_binary & !truth_binary)
  tn <- sum(!pred_binary & !truth_binary)
  fn <- sum(!pred_binary & truth_binary)
  
  sensitivity <- ifelse(tp + fn > 0, tp / (tp + fn), 0)
  specificity <- ifelse(tn + fp > 0, tn / (tn + fp), 0)
  precision <- ifelse(tp + fp > 0, tp / (tp + fp), 0)
  f1_score <- ifelse(precision + sensitivity > 0, 2 * (precision * sensitivity) / (precision + sensitivity), 0)
  
  cosine_sim <- mean(apply(cbind(pred_matrix, truth_matrix), 1, function(row_data) {
    pred_row <- row_data[1:ncol(pred_matrix)]
    truth_row <- row_data[(ncol(pred_matrix)+1):(2*ncol(pred_matrix))]
    sum(pred_row * truth_row) / (sqrt(sum(pred_row^2)) * sqrt(sum(truth_row^2)))
  }))
  
  return(data.frame(
    Method = method_name,
    RMSE = rmse,
    MAE = mae,
    Correlation = correlation,
    R_squared = r_squared,
    Sensitivity = sensitivity,
    Specificity = specificity,
    Precision = precision,
    F1_Score = f1_score,
    Cosine_Similarity = cosine_sim
  ))
}

# Calculate metrics for all methods
all_metrics <- bind_rows(
  calculate_metrics(cibersort_data, ground_truth_proportions, "CIBERSORT"),
  calculate_metrics(music_data, ground_truth_proportions, "MuSiC"),
  calculate_metrics(dual_simplex_data, ground_truth_proportions, "Dual Simplex"),
  calculate_metrics(nmf_data, ground_truth_proportions, "NMF"),
  calculate_metrics(nlls_data, ground_truth_proportions, "NLLS"),
  calculate_metrics(nlls_quadprog_data, ground_truth_proportions, "NLLS + Quadprog"),
  calculate_metrics(hspe_data, ground_truth_proportions, "HSPE")
)

# Prepare radar data
radar_data <- all_metrics
radar_data$RMSE_Accuracy <- 1 - (radar_data$RMSE / max(radar_data$RMSE))
radar_data$MAE_Accuracy <- 1 - (radar_data$MAE / max(radar_data$MAE))

radar_data <- radar_data[, c("Method", "RMSE_Accuracy", "MAE_Accuracy", "Correlation", 
                             "R_squared", "Sensitivity", "Specificity", "Precision", 
                             "F1_Score", "Cosine_Similarity")]

# Prepare for fmsb
radar_matrix <- as.matrix(radar_data[, -1])
rownames(radar_matrix) <- radar_data$Method

radar_for_plot <- rbind(
  rep(1, ncol(radar_matrix)),
  rep(0, ncol(radar_matrix)),
  radar_matrix
)
radar_for_plot <- as.data.frame(radar_for_plot)

# Create radar plot
colors <- rainbow(nrow(radar_data))

pdf("deconvolution_radar_simple.pdf", width = 12, height = 8)
par(mfrow = c(3, 3), mar = c(1, 1, 2, 1))

# Individual method plots
for (i in 1:nrow(radar_data)) {
  single_method_data <- as.data.frame(radar_for_plot[c(1, 2, i + 2), ])
  radarchart(single_method_data,
             axistype = 1,
             pcol = colors[i],
             pfcol = scales::alpha(colors[i], 0.3),
             plwd = 3,
             cglcol = "grey",
             cglty = 1,
             axislabcol = "black",
             caxislabels = seq(0, 1, 0.2),
             cglwd = 1.2,
             vlcex = 0.9,
             title = radar_data$Method[i])
}

# All methods comparison overlay
radarchart(as.data.frame(radar_for_plot),
           axistype = 1,
           pcol = colors,
           pfcol = scales::alpha(colors, 0.1),
           plwd = 3,
           cglcol = "grey",
           cglty = 1,
           axislabcol = "black",
           caxislabels = seq(0, 1, 0.2),
           cglwd = 1.2,
           vlcex = 0.9,
           title = "All Methods Comparison")

# Legend panel
plot.new()
legend("center",
       legend = radar_data$Method,
       col = colors,
       lty = 1,
       lwd = 3,
       cex = 1.0,
       bty = "n")

dev.off()

# Also save as PNG at 600 DPI
png("deconvolution_radar_simple.png", width = 3600, height = 2700, res = 600)
par(mfrow = c(3, 3), mar = c(1, 1, 2, 1), family = "sans", font = 2, font.lab = 2, font.axis = 2)

for (i in 1:nrow(radar_data)) {
  single_method_data <- as.data.frame(radar_for_plot[c(1, 2, i + 2), ])
  radarchart(single_method_data,
             axistype = 1,
             pcol = colors[i],
             pfcol = scales::alpha(colors[i], 0.3),
             plwd = 3,
             cglcol = "grey",
             cglty = 1,
             axislabcol = "black",
             caxislabels = seq(0, 1, 0.2),
             cglwd = 1.2,
             vlcex = 0.9,
             title = radar_data$Method[i])
}

# All methods comparison overlay
radarchart(as.data.frame(radar_for_plot),
           axistype = 1,
           pcol = colors,
           pfcol = scales::alpha(colors, 0.1),
           plwd = 3,
           cglcol = "grey",
           cglty = 1,
           axislabcol = "black",
           caxislabels = seq(0, 1, 0.2),
           cglwd = 1.2,
           vlcex = 0.9,
           title = "All Methods Comparison")

plot.new()
legend("center",
       legend = radar_data$Method,
       col = colors,
       lty = 1,
       lwd = 3,
       cex = 1.0,
       bty = "n")

dev.off()

########## Figure 5 ##########

# Define the ground truth data
ground_truth_data <- data.frame(
  Mix = c("Mix1", "Mix2", "Mix3", "Mix4", "Mix5", "Mix6"),
  Breast = c(0.15, 0, 0.15, 0, 0.15, 0),
  Blymphocyte = c(0.05, 0, 0.05, 0, 0.05, 0.1),
  `Blymphocyte-stim` = c(0.1, 0, 0.1, 0, 0.1, 0.2),
  Kidney = c(0.5, 0, 0.5, 0.1, 0.5, 0),
  Colon = c(0.2, 0, 0.2, 0.05, 0.2, 0),
  Myeloid = c(0, 0.1, 0, 0, 0, 0.2),
  Lung = c(0, 0.05, 0, 0.15, 0, 0),
  Pancreas = c(0, 0.15, 0, 0.5, 0, 0),
  Platelets = c(0, 0.2, 0, 0, 0, 0.2),
  Prostate = c(0, 0.5, 0, 0.2, 0, 0),
  TLymphocyte = c(0, 0, 0, 0, 0, 0.1),
  `Tlymphocyte.Stim` = c(0.1, 0, 0.1, 0, 0.1, 0.2)
)

# CIBERSORT results
cibersort_data <- data.frame(
  Mix = c("Mix1", "Mix2", "Mix3", "Mix4", "Mix5", "Mix6"),
  Blymphocyte = c(0.03544808, 0, 0.03252584, 0, 0.03250260, 0.08171565),
  `Blymphocyte-stim` = c(0.08664369, 0.00126137, 0.08088334, 0, 0.08271591, 0.09938276),
  Breast = c(0.11235536, 0.01629801, 0.09664910, 0, 0.09964531, 0),
  Colon = c(0.25059464, 0, 0.23872318, 0.02845874, 0.23804884, 0.06797212),
  Kidney = c(0.43977047, 0.00179195, 0.45368759, 0.09968292, 0.45652048, 0.00471870),
  Lung = c(0, 0, 0, 0.09055198, 0, 0),
  Myeloid = c(0.00849479, 0.11615454, 0.01207317, 0.03619246, 0.01252438, 0.18837339),
  Pancreas = c(0, 0.09053287, 0, 0.35302824, 0, 0.07521662),
  Platelets = c(0.00341864, 0.26163745, 0.00324551, 0.00125320, 0.00341519, 0.22299663),
  Prostate = c(0.05182007, 0.44337890, 0.05666456, 0.33556718, 0.05160016, 0),
  TLymphocyte = c(0.01145425, 0.06894490, 0.02554770, 0.05526527, 0.02302712, 0.16715631),
  `Tlymphocyte.Stim` = c(0, 0, 0, 0, 0, 0.09246781)
)

# MuSiC results
music_data <- data.frame(
  Mix = c("Mix1", "Mix2", "Mix3", "Mix4", "Mix5", "Mix6"),
  Blymphocyte = c(0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000),
  `Blymphocyte-stim` = c(0.1521, 0.0292, 0.1518, 0.0000, 0.1518, 0.3735),
  Breast = c(0.1379, 0.0895, 0.1409, 0.1444, 0.1455, 0.0000),
  Colon = c(0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000),
  Kidney = c(0.4850, 0.0000, 0.4841, 0.1926, 0.4845, 0.0118),
  Lung = c(0.0386, 0.0000, 0.0405, 0.0272, 0.0388, 0.0000),
  Myeloid = c(0.0000, 0.0334, 0.0000, 0.0000, 0.0000, 0.0840),
  Pancreas = c(0.1832, 0.6284, 0.1785, 0.4941, 0.1753, 0.0000),
  Platelets = c(0.0031, 0.2194, 0.0042, 0.0000, 0.0041, 0.3105),
  Prostate = c(0.0000, 0.0000, 0.0000, 0.1417, 0.0000, 0.0000),
  TLymphocyte = c(0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000),
  `Tlymphocyte.Stim` = c(0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.2202)
)

# Dual simplex data
dual_simplex_data <- data.frame(
  Mix = c("Mix1", "Mix2", "Mix3", "Mix4", "Mix5", "Mix6"),
  Blymphocyte = c(2.976693e-18, 7.238377e-18, 3.810873e-18, -7.684857e-17, 1.201748e-18, 3.167624e-01),
  `Blymphocyte-stim` = c(7.574810e-17, -1.390507e-17, 1.199754e-16, -6.873815e-17, 7.879790e-17, -4.377621e-17),
  Breast = c(2.211915e-01, -1.902651e-18, 2.015607e-01, 3.899711e-02, 2.230418e-01, 8.847443e-18),
  Colon = c(1.738153e-17, 5.949081e-17, -3.138531e-17, 2.658724e-17, -2.370326e-17, 3.372543e-17),
  Kidney = c(7.788085e-01, -9.151554e-20, 7.789732e-01, 5.110100e-01, 7.769582e-01, 2.137894e-02),
  Lung = c(2.292003e-16, -2.691641e-18, 1.467332e-16, -1.953111e-16, 1.623951e-16, -3.679393e-18),
  Myeloid = c(-3.110588e-17, -1.203341e-17, 3.859512e-18, -9.090631e-18, 3.661281e-18, 1.622476e-01),
  Pancreas = c(9.840948e-20, 2.812259e-01, 1.946611e-02, 4.457316e-01, -8.456681e-20, 9.897054e-18),
  Platelets = c(1.965248e-19, 4.597098e-01, -2.979761e-18, -2.174889e-18, -7.746821e-18, 4.996111e-01),
  Prostate = c(-4.045234e-16, 2.590643e-01, -3.853790e-16, 4.261314e-03, -3.972425e-16, -4.676349e-17),
  TLymphocyte = c(1.846640e-17, 8.554129e-17, -2.019911e-17, -6.120612e-17, -9.974101e-18, 3.153791e-18),
  `Tlymphocyte.Stim` = c(4.555504e-18, -1.226786e-16, -1.787359e-16, -7.578306e-18, -1.620348e-16, -3.279305e-17)
)

# NMF data
nmf_data <- data.frame(
  Mix = c("Mix1", "Mix2", "Mix3", "Mix4", "Mix5", "Mix6"),
  Kidney = c(0.457979119488629, 0.185977102488706, 0.531021251206337, 0.502372808205509, 0.533846250843462, 0),
  Prostate = c(0.148089221818423, 0.143953065170294, 0.128478892224605, 0.369368737367811, 0.128807232839981, 0),
  Blymphocyte = c(0.291652417773992, 0, 0.279720122165664, 0.0901060282196631, 0.281617015935284, 0.642201452023517),
  Lung = c(0.0850678482028392, 0, 0.0400326835047353, 0, 0.033927058695742, 0),
  Platelets = c(0.0172113927161165, 0.670069832341001, 0.0207470508986588, 0.0381524262070174, 0.0218024416855307, 0.357798547976483),
  `Blymphocyte-stim` = c(0, 0, 0, 0, 0, 0),
  Breast = c(0, 0, 0, 0, 0, 0),
  Colon = c(0, 0, 0, 0, 0, 0),
  Myeloid = c(0, 0, 0, 0, 0, 0),
  Pancreas = c(0, 0, 0, 0, 0, 0),
  TLymphocyte = c(0, 0, 0, 0, 0, 0),
  `Tlymphocyte.Stim` = c(0, 0, 0, 0, 0, 0)
)

# NLLS data
nlls_data <- data.frame(
  Mix = c("Mix1", "Mix2", "Mix3", "Mix4", "Mix5", "Mix6"),
  Blymphocyte = c(0.00000000, 0.00000000, 0.00000000, 0.00000000, 0.00000000, 0.01346631),
  `Blymphocyte-stim` = c(0.14497517, 0.06518118, 0.14463538, 0.07297522, 0.14496675, 0.17008175),
  Breast = c(0.20239329, 0.07195102, 0.20496013, 0.06024032, 0.20700451, 0.04195438),
  Colon = c(0, 0, 0, 0, 0, 0),
  Kidney = c(0.20581673, 0.00000000, 0.20448794, 0.06222798, 0.20492304, 0.00000000),
  Lung = c(0.114395529, 0.075318773, 0.115758372, 0.173507490, 0.114689313, 0.002686254),
  Myeloid = c(0.00000000, 0.07400891, 0.00000000, 0.00000000, 0.00000000, 0.14655733),
  Pancreas = c(0.2176951, 0.2787699, 0.2137560, 0.4543043, 0.2124891, 0.2382445),
  Platelets = c(0.02487181, 0.21880772, 0.02554621, 0.01358061, 0.02555993, 0.21202936),
  Prostate = c(0.0000000, 0.1941958, 0.0000000, 0.1175246, 0.0000000, 0.0000000),
  TLymphocyte = c(0, 0, 0, 0, 0, 0),
  `Tlymphocyte.Stim` = c(0.08985239, 0.02176675, 0.09085595, 0.04563950, 0.09036731, 0.17498015)
)

# NLLS + Quadprog data
nlls_quadprog_data <- data.frame(
  Mix = c("Mix1", "Mix2", "Mix3", "Mix4", "Mix5", "Mix6"),
  Blymphocyte = c(0.13890662, 0.01790041, 0.13438085, 0.00000000, 0.13809594, 0.15230924),
  `Blymphocyte-stim` = c(0.01885689, 0.11195282, 0.02396899, 0.09890843, 0.01059959, 0.11621152),
  Breast = c(0.15009062, 0.05285325, 0.12813621, 0.06800441, 0.13039702, 0.06593136),
  Colon = c(0.18793321, 0.03400344, 0.18371456, 0.06060474, 0.18506425, 0.03504738),
  Kidney = c(0.23002136, 0.00000000, 0.22326926, 0.08466211, 0.23301971, 0.00000000),
  Lung = c(0.06017492, 0.08174585, 0.07365307, 0.15710046, 0.06941715, 0.04274868),
  Myeloid = c(0.05374678, 0.10938500, 0.05719799, 0.02843053, 0.05552310, 0.13377374),
  Pancreas = c(0.00000000, 0.09745456, 0.02085993, 0.18935251, 0.01879435, 0.06185263),
  Platelets = c(0.03130424, 0.13532285, 0.02645816, 0.04282437, 0.02304654, 0.12940003),
  Prostate = c(0.000000000, 0.231680540, 0.000000000, 0.120704113, 0.000000000, 0.006297306),
  TLymphocyte = c(0.11643794, 0.03882258, 0.11013243, 0.03525185, 0.10816389, 0.13252163),
  `Tlymphocyte.Stim` = c(0.01252742, 0.08887870, 0.01822855, 0.11415648, 0.02787847, 0.12390649)
)

# HSPE data
hspe_data <- data.frame(
  Mix = c("Mix1", "Mix2", "Mix3", "Mix4", "Mix5", "Mix6"),
  Blymphocyte = c(0.0615462915975005, 2.10986670974832e-14, 0.056581668354361, 1.63333935287624e-14, 0.0538422302761945, 0.109253055838156),
  `Blymphocyte-stim` = c(0.17205189564674, 8.9529327722133e-15, 0.149085653208496, 2.12357239506118e-14, 0.158076349966032, 0.565480232581023),
  Breast = c(0.159174908896492, 1.12054921216177e-12, 0.157809904032517, 2.37654512353938e-12, 0.168462474830569, 8.15028066494612e-14),
  Colon = c(0.184944097814528, 0.000860432365042374, 0.215606708016647, 0.0440677338966095, 0.216085511553033, 0.0017857447927055),
  Kidney = c(0.374188781259241, 0.000276500335019246, 0.369621003708629, 0.0638667986895588, 0.359589944467675, 0.000600596018706707),
  Lung = c(0.00113345682398526, 0.0555962521047241, 0.00253299657465361, 0.0691174535927729, 0.00392343153901516, 0.0318630911936676),
  Myeloid = c(0.000410236518530606, 0.0405496285468119, 0.000551736347792372, 0.000350613878038412, 0.000542608602068294, 0.0826691200391667),
  Pancreas = c(0.0419007094640993, 0.125321093618446, 0.0445982183455745, 0.480411225036451, 0.0280126639522533, 0.000201941790806037),
  Platelets = c(8.29940111804725e-06, 0.0500390217826638, 1.40926938417996e-05, 2.48108732758093e-06, 1.23863298025725e-05, 0.0534074739655798),
  Prostate = c(2.25871144600948e-11, 0.726862588963815, 0.0016033206481104, 0.341233007697635, 0.00695016108583158, 1.19323243989806e-12),
  TLymphocyte = c(0.0046413225549792, 2.01007047484897e-05, 0.00199469806852641, 0.0003042093938911, 0.00210970378859576, 0.0726900406644244),
  `Tlymphocyte.Stim` = c(1.98289893473012e-13, 0.000474381577578971, 8.49851697974119e-13, 0.000646476725300891, 0.00239253360892957, 0.08204870311449)
)

normalize_and_standardize <- function(df, method_name = "Unknown") {
  cat("Processing", method_name, "...\n")
  
  all_cell_types <- c("Breast", "Blymphocyte", "Blymphocyte-stim", "Kidney", 
                      "Colon", "Myeloid", "Lung", "Pancreas", "Platelets", 
                      "Prostate", "TLymphocyte", "Tlymphocyte-Stim")
  
  standardized_df <- data.frame(Mix = df$Mix)
  
  for (cell_type in all_cell_types) {
    if (cell_type %in% names(df)) {
      standardized_df[[cell_type]] <- as.numeric(df[[cell_type]])
    } else {
      standardized_df[[cell_type]] <- 0
    }
  }
  
  for (i in 1:nrow(standardized_df)) {
    row_values <- as.numeric(standardized_df[i, -1])
    row_values[row_values < 0] <- 0
    row_values[abs(row_values) < 1e-12] <- 0
    row_sum <- sum(row_values, na.rm = TRUE)
    
    if (row_sum <= 1e-12) {
      row_values <- rep(0, length(row_values))
      row_sum <- 0
    }
    
    if (row_sum > 0) {
      row_values <- row_values / row_sum
    } else {
      row_values <- rep(1/length(row_values), length(row_values))
    }
    
    current_sum <- sum(row_values)
    if (abs(current_sum - 1.0) > 1e-14) {
      max_idx <- which.max(row_values)
      adjustment <- 1.0 - current_sum
      row_values[max_idx] <- row_values[max_idx] + adjustment
    }
    
    standardized_df[i, -1] <- row_values
  }
  
  row_sums <- rowSums(standardized_df[, -1])
  cat("  Final row sums:", round(row_sums, 15), "\n")
  
  return(standardized_df)
}

ground_truth_processed <- normalize_and_standardize(ground_truth_data, "Ground Truth")
music_processed <- normalize_and_standardize(music_data, "MuSiC")
cibersort_processed <- normalize_and_standardize(cibersort_data, "CIBERSORT")
dual_simplex_processed <- normalize_and_standardize(dual_simplex_data, "Dual Simplex")
nmf_processed <- normalize_and_standardize(nmf_data, "NMF")
nlls_processed <- normalize_and_standardize(nlls_data, "NLLS")
nlls_quadprog_processed <- normalize_and_standardize(nlls_quadprog_data, "NLLS + Quadprog")
hspe_processed <- normalize_and_standardize(hspe_data, "HSPE")

to_long_format <- function(df, method_name) {
  df %>%
    pivot_longer(cols = -Mix, names_to = "Cell_Type", values_to = "Proportion") %>%
    mutate(Method = method_name,
           Cell_Type = gsub("\\.", "-", Cell_Type))
}

all_data_long <- bind_rows(
  to_long_format(ground_truth_processed, "Ground Truth"),
  to_long_format(music_processed, "MuSiC"),
  to_long_format(cibersort_processed, "CIBERSORT"),
  to_long_format(dual_simplex_processed, "Dual Simplex"),
  to_long_format(nmf_processed, "NMF"),
  to_long_format(nlls_processed, "NLLS"),
  to_long_format(nlls_quadprog_processed, "NLLS + Quadprog"),
  to_long_format(hspe_processed, "HSPE")
)

color_palette <- c(
  "Blymphocyte" = "goldenrod1",
  "Blymphocyte-stim" = "goldenrod",
  "Tlymphocyte-Stim" = "honeydew4",
  "TLymphocyte" = "honeydew3",
  "Myeloid" = "red4",
  "Platelets" = "firebrick2",
  "Breast" = "violetred",
  "Prostate" = "dodgerblue4",
  "Pancreas" = "chartreuse4",
  "Lung" = "skyblue",
  "Kidney" = "coral",
  "Colon" = "sienna4"
)

method_order <- c("Ground Truth", "CIBERSORT", "MuSiC", "Dual Simplex", 
                  "NMF", "NLLS", "NLLS + Quadprog", "HSPE")

plot_list <- list()
for (mix_id in c("Mix2", "Mix4", "Mix6")) {
  mix_data <- all_data_long %>% 
    filter(Mix == mix_id) %>%
    mutate(Method = factor(Method, levels = method_order),
           x_position = ifelse(Method == "Ground Truth", 1, 
                               as.numeric(Method) + 0.5))
  
  p <- ggplot(mix_data, aes(x = x_position, y = Proportion, fill = Cell_Type, group = Method)) +
    geom_bar(stat = "identity", position = "stack", width = 0.7) +
    scale_fill_manual(values = color_palette) +
    scale_x_continuous(
      breaks = c(1, 2.5, 3.5, 4.5, 5.5, 6.5, 7.5, 8.5),
      labels = method_order,
      expand = expansion(mult = c(0.02, 0.02))
    ) +
    scale_y_continuous(limits = c(0, 1.01), breaks = seq(0, 1, by = 0.2),
                       labels = scales::percent_format(accuracy = 1)) +
    labs(x = NULL, y = "Proportion") +
    theme_minimal() +
    theme(
      legend.position = "none",
      axis.text.x = element_text(angle = 45, hjust = 1, size = 9, face = "bold"),
      axis.text.y = element_text(face = "bold"),
      axis.title.y = element_text(size = 10, face = "bold"),
      plot.title = element_blank(),
      panel.grid.minor = element_blank(),
      plot.margin = margin(t = 20, r = 5, b = 5, l = 5)
    )
  
  plot_list[[mix_id]] <- p
}

img <- readPNG("/Users/alexboudreau/Desktop/hspe_per_depth.png")
panel_d <- ggplot() + 
  annotation_custom(rasterGrob(img, width = unit(1, "npc"), height = unit(1, "npc"), 
                               interpolate = TRUE)) +
  theme_void() +
  theme(plot.margin = margin(t = 20, r = 0, b = 0, l = 0))

# Create a custom grob with panel labels A, B, C, D
create_labeled_plot <- function() {
  grid.newpage()
  
  pushViewport(viewport(layout = grid.layout(1, 2, widths = unit(c(1, 1), "null"))))
  
  pushViewport(viewport(layout.pos.row = 1, layout.pos.col = 1))
  
  pushViewport(viewport(layout = grid.layout(3, 1, heights = unit(c(1, 1, 1), "null"))))
  
  pushViewport(viewport(layout.pos.row = 1, layout.pos.col = 1))
  print(plot_list$Mix2, newpage = FALSE)
  grid.text("A", x = unit(0.02, "npc"), y = unit(0.98, "npc"), 
            just = c("left", "top"), 
            gp = gpar(fontsize = 18, fontface = "bold"))
  popViewport()
  
  pushViewport(viewport(layout.pos.row = 2, layout.pos.col = 1))
  print(plot_list$Mix4, newpage = FALSE)
  grid.text("B", x = unit(0.02, "npc"), y = unit(0.98, "npc"), 
            just = c("left", "top"), 
            gp = gpar(fontsize = 18, fontface = "bold"))
  popViewport()
  
  pushViewport(viewport(layout.pos.row = 3, layout.pos.col = 1))
  print(plot_list$Mix6, newpage = FALSE)
  grid.text("C", x = unit(0.02, "npc"), y = unit(0.98, "npc"), 
            just = c("left", "top"), 
            gp = gpar(fontsize = 18, fontface = "bold"))
  popViewport()
  
  popViewport()
  popViewport()
  
  pushViewport(viewport(layout.pos.row = 1, layout.pos.col = 2))
  print(panel_d, newpage = FALSE)
  grid.text("D", x = unit(0.02, "npc"), y = unit(0.98, "npc"), 
            just = c("left", "top"), 
            gp = gpar(fontsize = 18, fontface = "bold"))
  popViewport()
}

# Save at publication quality
pdf("multi_panel_figure.pdf", width = 16, height = 10)
create_labeled_plot()
dev.off()

png("multi_panel_figure.png", width = 16, height = 10, units = "in", res = 600)
create_labeled_plot()
dev.off()

# Display
create_labeled_plot()

########## Figure 6 ##########

group_colors = c("B_cell"="goldenrod1","T_cell"="honeydew4","Myeloid"="red4","Platelet"="firebrick2","Breast"="violetred","Prostate"="dodgerblue4","Pancreas"="chartreuse4","Lung"="skyblue","Kidney"="coral","Colon"="sienna4")

dat<- read.table(file.choose(), sep = "\t", header = T) # CRC estimates imported after deconvolution
dat1 <- dat[,-c(12,13,14)]
rownames(dat1) <- dat$Mixture
dat1<- dat1[,-1]
Mat <- as.matrix(dat1)

anno <- read.table(file.choose(), header = T, sep = "\t") # File with CRC statuses
anno[anno==1] <- "Precancerous"
anno[anno=="2"] <- "Cancer"
anno[anno==0] <- "Healthy"
anno1 <- factor(anno, levels = c("Healthy", "Precancerous", "Cancer"))
ha = HeatmapAnnotation(Status = anno1) # phenotype info
Heatmap(t(Mat+0.0000001), cluster_columns = T, name = "Abundance Estimate",top_annotation = ha, show_column_names=F)

g1 <- as.data.frame(t(Mat))
g1$Type <- rownames(g1)

g1 <- melt(g1)
names(g1) <- c("Type", "Status", "Estimated Proportion")
g1$Status <- rep(anno1, each=10)

p <- ggplot(g1, aes(Type, `Estimated Proportion`, fill = Status)) + geom_boxplot(position = "dodge")+theme_bw()

ggsave("Boxplot_cibersortv7_filter_consolidated.png", dpi = 600, width=7, height = 3,p)

########## Figure 7 ##########

pseudo_counts <- log2(Mat+1)
pseudo_counts_cen <- pseudo_counts - rowMeans(pseudo_counts)
svd1<-svd(pseudo_counts_cen)
svd_percent<-(svd1$d^2/sum(svd1$d^2))
plot(svd_percent,main="% variance explained",col=2)

plot(svd1$v[,1],svd1$v[,2],ylab="2nd PC",xlab="1st PC")

PCA <- cbind(svd1$v[,1], svd1$v[,2], anno$Type)
colnames(PCA) <- c("PC1", "PC2", "Type")
PCA <- as.data.frame(PCA)
PCA$PC1 <- as.numeric(PCA$PC1)
PCA$PC2 <- as.numeric(PCA$PC2)

g <- ggplot(PCA) + geom_point(aes(x = PC1, y=PC2, colour=`Type`), size = 2.5)+ labs(title="", x="1st Principal Component", y = "2nd Principal Component") + theme_bw()
g
ggsave("PCA.png", dpi = 600, width=5, height = 4,g)

